import{a as I,g as m,p as wt,d as vt}from"./dates-D_KJE76d.js";import{f}from"./format-money-C9cJykQv.js";import{g as P,s as mt,G as lt}from"./get-Y0NwWboE.js";import{s as H,f as y,C as S,a as C,i as g,S as Ct,F as kt,L as Pt,b as Dt,A as xt,B as Ot,T as Ft,P as St,c as At,d as Mt,p as Bt,e as jt,g as Wt,h as It,j as Vt,k as $t}from"./vendor-CTKi4Xbf.js";import{G as Kt}from"./get-B9BSmHxD.js";import{G as Gt,a as Lt}from"./get-FFCI7Ml_.js";class Et{get(e,a,n){return I.get("/api/v2/summary/basic",{params:{start:e,end:a,code:n}})}}function Tt(){const t=H.get("lastActivity");H.each(function(e,a){a.startsWith("dcx")&&!a.includes(t)&&H.remove(a)})}let J=!1;const Rt=()=>({balanceBox:{amounts:[],subtitles:[]},billBox:{paid:[],unpaid:[]},leftBox:{left:[],perDay:[]},netBox:{net:[]},autoConversion:!1,loading:!1,boxData:null,boxOptions:null,getFreshData(){const t=new Date(window.store.get("start")),e=new Date(window.store.get("end")),a=P("ds_boxes_data",{start:t,end:e});Tt();const n=window.store.get("cacheValid");let r=window.store.get(a);if(n&&typeof r<"u"){this.boxData=r,this.generateOptions(this.boxData);return}new Et().get(y(t,"yyyy-MM-dd"),y(e,"yyyy-MM-dd"),null).then(i=>{this.boxData=i.data,window.store.set(a,i.data),this.generateOptions(this.boxData)})},generateOptions(t){this.balanceBox={amounts:[],subtitles:[]},this.billBox={paid:[],unpaid:[]},this.leftBox={left:[],perDay:[]},this.netBox={net:[]};let e={};for(const a in t)if(t.hasOwnProperty(a)){const n=t[a];if(!n.hasOwnProperty("key"))continue;let r=n.key;if(this.autoConversion){if(r.startsWith("balance-in-native")){this.balanceBox.amounts.push(f(n.value,n.currency_code)),e.hasOwnProperty(n.currency_code)||(e[n.currency_code]="");continue}if(r.startsWith("spent-in-native")){e.hasOwnProperty(n.currency_code)||(e[n.currency_code]=""),e[n.currency_code]=e[n.currency_code]+f(n.value,n.currency_code);continue}if(r.startsWith("earned-in-native")){e.hasOwnProperty(n.currency_code)||(e[n.currency_code]=""),e[n.currency_code]=f(n.value,n.currency_code)+" + "+e[n.currency_code];continue}if(r.startsWith("bills-unpaid-in-native")){this.billBox.unpaid.push(f(n.value,n.currency_code));continue}if(r.startsWith("bills-paid-in-native")){this.billBox.paid.push(f(n.value,n.currency_code));continue}if(r.startsWith("left-to-spend-in-native")){this.leftBox.left.push(f(n.value,n.currency_code));continue}if(r.startsWith("left-per-day-to-spend-in-native")){this.leftBox.perDay.push(f(n.value,n.currency_code));continue}if(r.startsWith("net-worth-in-native")){this.netBox.net.push(f(n.value,n.currency_code));continue}}if(!this.autoConversion&&!r.endsWith("native")){if(r.startsWith("balance-in-")){this.balanceBox.amounts.push(f(n.value,n.currency_code));continue}if(r.startsWith("spent-in-")){e.hasOwnProperty(n.currency_code)||(e[n.currency_code]=""),e[n.currency_code]=e[n.currency_code]+f(n.value,n.currency_code);continue}if(r.startsWith("earned-in-")){e.hasOwnProperty(n.currency_code)||(e[n.currency_code]=""),e[n.currency_code]=f(n.value,n.currency_code)+" + "+e[n.currency_code];continue}if(r.startsWith("bills-unpaid-in-")){this.billBox.unpaid.push(f(n.value,n.currency_code));continue}if(r.startsWith("bills-paid-in-")){this.billBox.paid.push(f(n.value,n.currency_code));continue}if(r.startsWith("left-to-spend-in-")){this.leftBox.left.push(f(n.value,n.currency_code));continue}if(r.startsWith("left-per-day-to-spend-in-")){this.leftBox.perDay.push(f(n.value,n.currency_code));continue}r.startsWith("net-worth-in-")&&this.netBox.net.push(f(n.value,n.currency_code))}}for(let a in e)e.hasOwnProperty(a)&&this.balanceBox.subtitles.push(e[a]);this.loading=!1},loadBoxes(){if(this.loading!==!0){if(this.loading=!0,this.boxData===null){this.getFreshData();return}this.generateOptions(this.boxData),this.loading=!1}},init(){Promise.all([m("viewRange"),m("autoConversion",!1)]).then(t=>{J=!0,this.autoConversion=t[1],this.loadBoxes()}),window.store.observe("end",()=>{J&&(this.boxData=null,this.loadBoxes())}),window.store.observe("autoConversion",t=>{J&&(this.autoConversion=t,this.loadBoxes())})}});let Nt=class{dashboard(e,a){let n=y(e,"y-MM-dd"),r=y(a,"y-MM-dd");return I.get("/api/v2/chart/account/dashboard",{params:{start:n,end:r}})}expense(e,a){let n=y(e,"y-MM-dd"),r=y(a,"y-MM-dd");return I.get("/api/v2/chart/account/expense-dashboard",{params:{start:n,end:r}})}};function U(t){return t==="sankey"?{type:"sankey",data:{datasets:[]},options:{animations:!1}}:t==="pie"?{type:"pie",data:{datasets:[]}}:t==="column"?{type:"bar",data:{labels:[],datasets:[]},options:{plugins:{tooltip:{callbacks:{label:function(e){let a=e.dataset.currency_code;return f(e.raw,a)}}}},maintainAspectRatio:!1,scales:{}}}:t==="line"?{options:{plugins:{tooltip:{callbacks:{label:function(e){let a=e.dataset.currency_code;return f(e.raw,a)}}}},maintainAspectRatio:!1,scales:{x:{type:"time",time:{tooltipFormat:"PP"}}}},type:"line",data:{labels:[],datasets:[]}}:{}}class qt{getByName(e){return I.get("/api/v1/configuration/"+e)}}function Yt(t,e=null){const a=window.store.get("cacheValid");if(a&&window.hasOwnProperty(t))return Promise.resolve(window[t]);const n=window.store.get(t);return a&&typeof n<"u"?Promise.resolve(n):new qt().getByName(t).then(o=>Promise.resolve(wt(t,o))).catch(()=>e)}let A=[],V=null,Z=null,Q=!1;const Ut=()=>({loading:!1,loadingAccounts:!1,accountList:[],autoConversion:!1,autoConversionAvailable:!1,chartOptions:null,switchAutoConversion(){this.autoConversion=!this.autoConversion,mt("autoConversion",this.autoConversion)},localCacheKey(t){return"ds_accounts_"+t},getFreshData(){const t=new Date(window.store.get("start")),e=new Date(window.store.get("end")),a=P(this.localCacheKey("chart"),{start:t,end:e}),n=window.store.get("cacheValid");let r=window.store.get(a);if(n&&typeof r<"u"){this.drawChart(this.generateOptions(r)),this.loading=!1;return}new Nt().dashboard(t,e,null).then(i=>{this.chartData=i.data,window.store.set(a,i.data),this.drawChart(this.generateOptions(this.chartData)),this.loading=!1})},generateOptions(t){A=[];let e=U("line");for(let a=0;a<t.length;a++)if(t.hasOwnProperty(a)){let n="y",r=t[a],o={},i=[];a===0&&(e.data.labels=Object.keys(r.entries)),o.label=r.label,this.autoConversion&&(A.push(r.native_currency_code),o.currency_code=r.native_currency_code,i=Object.values(r.native_entries),n="y"+r.native_currency_code),this.autoConversion||(n="y"+r.currency_code,o.currency_code=r.currency_code,A.push(r.currency_code),i=Object.values(r.entries)),o.yAxisID=n,o.data=i,e.data.datasets.push(o)}for(let a in A)if(A.hasOwnProperty(a)){let n="y"+A[a];e.options.scales.hasOwnProperty(n)||(e.options.scales[n]={id:a,type:"linear",position:parseInt(a)===1?"right":"left",ticks:{callback:function(r,o,i){return f(r,A[a])}}})}return e},loadChart(){if(this.loading!==!0){if(this.loading=!0,Z===null){this.getFreshData();return}this.drawChart(this.generateOptions(Z)),this.loading=!1}},drawChart(t){if(V!==null){V.options=t.options,V.data=t.data,V.update();return}V=new S(document.querySelector("#account-chart"),t)},loadAccounts(){if(this.loadingAccounts===!0)return;if(this.loadingAccounts=!0,this.accountList.length>0){this.loadingAccounts=!1;return}const t=new Date(window.store.get("start")),e=new Date(window.store.get("end")),a=P(this.localCacheKey("data"),{start:t,end:e}),n=window.store.get("cacheValid");let r=window.store.get(a);if(n&&typeof r<"u"){this.accountList=r,this.loadingAccounts=!1;return}const o=10;let i=0,l=0,u=[];Promise.all([m("frontpageAccounts")]).then(d=>{i=d[0].length;for(let h in d[0]){let c=d[0];if(c.hasOwnProperty(h)){let p=c[h];new lt().show(p,new Date(window.store.get("end"))).then(v=>{let k=v.data.data;const bt={page:1,start:new Date(window.store.get("start")),end:new Date(window.store.get("end"))};new lt().transactions(k.id,bt).then(ot=>{let it=[];for(let M=0;M<ot.data.data.length&&!(M>=o);M++){let O=ot.data.data[M],st={title:O.attributes.group_title===null?"":O.attributes.group_title,id:O.id,transactions:[]};for(let z=0;z<O.attributes.transactions.length;z++){let w=O.attributes.transactions[z],T=w.type==="withdrawal"?parseFloat(w.native_amount)*-1:parseFloat(w.native_amount),R=w.type==="withdrawal"?parseFloat(w.amount)*-1:parseFloat(w.amount);w.type==="transfer"&&parseInt(w.source_id)===p&&(T=T*-1,R=R*-1),st.transactions.push({description:w.description,id:O.id,type:w.type,amount_raw:R,amount:f(R,w.currency_code),native_amount_raw:T,native_amount:f(T,w.native_currency_code)})}it.push(st)}u.push({name:k.attributes.name,order:k.attributes.order,id:k.id,balance_raw:parseFloat(k.attributes.current_balance),balance:f(k.attributes.current_balance,k.attributes.currency_code),native_balance_raw:parseFloat(k.attributes.native_current_balance),native_balance:f(k.attributes.native_current_balance,k.attributes.native_currency_code),groups:it}),l++,l===i&&(u.sort((M,O)=>M.order-O.order),this.accountList=u,this.loadingAccounts=!1,window.store.set(a,u))})})}}})},init(){Promise.all([m("viewRange","1M"),m("autoConversion",!1),m("language","en_US"),Yt("cer.enabled",!1)]).then(t=>{this.autoConversion=t[1]&&t[3],this.autoConversionAvailable=t[3],Q=!0,this.loadChart(),this.loadAccounts()}),window.store.observe("end",()=>{Q&&(Z=null,this.accountList=[],this.loadChart(),this.loadAccounts())}),window.store.observe("autoConversion",()=>{Q&&(this.loadChart(),this.loadAccounts())})}});let zt=class{dashboard(e,a){let n=y(e,"y-MM-dd"),r=y(a,"y-MM-dd");return I.get("/api/v2/chart/budget/dashboard",{params:{start:n,end:r}})}},Y=new C("#36a2eb"),W=new C("#ff6384"),E=new C("#4bc0c0"),gt=new C("#ff9f40"),Ht=new C("#9966ff"),Jt=new C("#ffcd56"),Zt=new C("#c9cbcf"),ut=0;window.theme==="dark"&&(W.darken(.3).desaturate(.3),E.darken(.3).desaturate(.3),Y.darken(.3).desaturate(.3),gt.darken(.3).desaturate(.3));let X=[W,gt,Y,E,Ht,Jt,Zt,E];function B(t,e){let a={borderColor:W.rgbString(),backgroundColor:W.rgbString()},n;switch(t){default:let o=Math.floor(ut/2)%X.length;n=new C(X[o].rgbString()),n.lighten(.38),a={borderColor:X[o].hexString(),backgroundColor:n.hexString()};break;case"spent":n=new C(Y.rgbString()),n.lighten(.38),a={borderColor:Y.rgbString(),backgroundColor:n.rgbString()};break;case"left":n=new C(E.rgbString()),n.lighten(.38),a={borderColor:E.rgbString(),backgroundColor:n.rgbString()};break;case"overspent":n=new C(W.rgbString()),n.lighten(.22),a={borderColor:W.rgbString(),backgroundColor:n.rgbString()};break}return ut++,e==="border"?a.borderColor:e==="background"?a.backgroundColor:"#FF0000"}let $=[],N=null,F=null,tt=!1;const Qt=()=>({loading:!1,autoConversion:!1,loadChart(){if(this.loading!==!0){if(this.loading=!0,F!==null){this.drawChart(this.generateOptions(F)),this.loading=!1;return}this.getFreshData()}},drawChart(t){if(N!==null){N.data.datasets=t.data.datasets,N.update();return}N=new S(document.querySelector("#budget-chart"),t)},getFreshData(){const t=new Date(window.store.get("start")),e=new Date(window.store.get("end")),a=P("ds_bdg_chart",{start:t,end:e}),n=window.store.get("cacheValid");let r=window.store.get(a);if(n&&typeof r<"u"){F=r,this.drawChart(this.generateOptions(F)),this.loading=!1;return}new zt().dashboard(t,e,null).then(i=>{F=i.data,this.drawChart(this.generateOptions(F)),window.store.set(a,F),this.loading=!1})},generateOptions(t){$=[];let e=U("column");e.options.locale=window.store.get("locale").replace("_","-"),e.options.plugins={tooltip:{callbacks:{title:function(a){return a.label},label:function(a){let n=a.dataset.label||"";return n&&(n+=": "),n+" "+f(a.parsed.y,$[a.parsed.x]??"EUR")}}}},e.data={labels:[],datasets:[{label:g.t("firefly.spent"),data:[],borderWidth:1,stack:1,backgroundColor:B("spent","background"),borderColor:B("spent","border")},{label:g.t("firefly.left"),data:[],borderWidth:1,stack:1,backgroundColor:B("left","background"),borderColor:B("left","border")},{label:g.t("firefly.overspent"),data:[],borderWidth:1,stack:1,backgroundColor:B("overspent","background"),borderColor:B("overspent","border")}]};for(const a in t)if(t.hasOwnProperty(a)){let n=t[a],r=n.label+" ("+n.currency_code+")";e.data.labels.push(r),this.autoConversion&&($.push(n.native_currency_code),e.data.datasets[0].data.push(parseFloat(n.native_entries.spent)*-1),e.data.datasets[1].data.push(parseFloat(n.native_entries.left)),e.data.datasets[2].data.push(parseFloat(n.native_entries.overspent))),this.autoConversion||($.push(n.currency_code),e.data.datasets[0].data.push(parseFloat(n.entries.spent)*-1),e.data.datasets[1].data.push(parseFloat(n.entries.left)),e.data.datasets[2].data.push(parseFloat(n.entries.overspent)))}return e.options.scales={y:{ticks:{callback:function(a){return f(a,$[0]??"EUR")}}}},e},init(){Promise.all([m("autoConversion",!1)]).then(t=>{this.autoConversion=t[0],tt=!0,this.loading===!1&&this.loadChart()}),window.store.observe("end",()=>{tt&&this.loading===!1&&(F=null,this.loadChart())}),window.store.observe("autoConversion",t=>{tt&&(this.autoConversion=t,this.loading===!1&&this.loadChart())})}});class Xt{dashboard(e,a){let n=y(e,"y-MM-dd"),r=y(a,"y-MM-dd");return I.get("/api/v2/chart/category/dashboard",{params:{start:n,end:r}})}}let ct=[],K=null,j=null,et=!1;const te=()=>({loading:!1,autoConversion:!1,generateOptions(t){ct=[];let e=U("column"),a={};for(const r in t)if(t.hasOwnProperty(r)){let o=t[r],i=o.currency_code;this.autoConversion&&(i=o.native_currency_code),a.hasOwnProperty(i)||(a[i]={name:i,yAxisID:"",data:{}},ct.push(i))}for(const r in t)if(t.hasOwnProperty(r)){let o=t[r],i=o.currency_code;this.autoConversion&&(i=o.native_currency_code);for(const l in a)if(a.hasOwnProperty(l)){let u=0;i===l&&(u=parseFloat(o.amount),""+o.currency_code,this.autoConversion&&(u=parseFloat(o.native_amount),""+o.native_currency_code)),a[l].data.hasOwnProperty(o.label)&&(a[l].data[o.label]=a[l].data[o.label]+u),a[l].data.hasOwnProperty(o.label)||(a[l].data[o.label]=u)}e.data.labels.includes(o.label)||e.data.labels.push(o.label)}let n=0;for(const r in a){let o="y"+r,i={label:r,currency_code:r,yAxisID:o,data:[]};for(const l in a[r].data)i.data.push(a[r].data[l]);e.data.datasets.push(i),e.options.scales.hasOwnProperty(o)||(e.options.scales[o]={beginAtZero:!0,type:"linear",position:n===1?"right":"left",ticks:{callback:function(l,u,d){return f(l,r)}}},n++)}return e},drawChart(t){if(K!==null){K.options=t.options,K.data=t.data,K.update();return}K=new S(document.querySelector("#category-chart"),t)},getFreshData(){const t=new Date(window.store.get("start")),e=new Date(window.store.get("end")),a=P("ds_ct_chart",{start:t,end:e}),n=window.store.get("cacheValid");let r=window.store.get(a);if(n&&typeof r<"u"){j=r,this.drawChart(this.generateOptions(j)),this.loading=!1;return}new Xt().dashboard(t,e,null).then(i=>{j=i.data,this.drawChart(this.generateOptions(i.data)),window.store.set(a,j),this.loading=!1})},loadChart(){if(this.loading!==!0){if(this.loading=!0,j!==null){this.drawChart(this.generateOptions(j)),this.loading=!1;return}this.getFreshData()}},init(){Promise.all([m("autoConversion",!1)]).then(t=>{this.autoConversion=t[0],et=!0,this.loadChart()}),window.store.observe("end",()=>{et&&(this.chartData=null,this.loadChart())}),window.store.observe("autoConversion",t=>{et&&(this.autoConversion=t,this.loadChart())})}});S.register({SankeyController:Ct,Flow:kt});const dt="ds_sankey_data";let at=!1,q=null,D=[],_=!1,s={category:null,unknown_category:null,in:null,out:null,unknown_source:null,unknown_dest:null,unknown_account:null,expense_account:null,revenue_account:null,budget:null,unknown_budget:null,all_money:null};const ht=function(t){return t.includes(s.revenue_account)?"forestgreen":t.includes("("+s.in+",")?"green":t.includes(s.budget)||t.includes(s.unknown_budget)?"Orchid":t.includes("("+s.out+",")?"MediumOrchid":t.includes(s.all_money)?"blue":"red"};function G(t,e,a,n){if(t==="category"&&e!==null&&a==="in")return s.category+' "'+e+'" ('+s.in+(_?", "+n+")":")");if(t==="category"&&e===null&&a==="in")return s.unknown_category+" ("+s.in+(_?", "+n+")":")");if(t==="category"&&e!==null&&a==="out")return s.category+' "'+e+'" ('+s.out+(_?", "+n+")":")");if(t==="category"&&e===null&&a==="out")return s.unknown_category+" ("+s.out+(_?", "+n+")":")");if(t==="account"&&e===null&&a==="in")return s.unknown_source+(_?" ("+n+")":"");if(t==="account"&&e!==null&&a==="in")return s.revenue_account+'"'+e+'"'+(_?" ("+n+")":"");if(t==="account"&&e===null&&a==="out")return s.unknown_dest+(_?" ("+n+")":"");if(t==="account"&&e!==null&&a==="out")return s.expense_account+' "'+e+'"'+(_?" ("+n+")":"");if(t==="budget"&&e!==null)return s.budget+' "'+e+'"'+(_?" ("+n+")":"");if(t==="budget"&&e===null)return s.unknown_budget+(_?" ("+n+")":"");console.error('Cannot handle: type:"'+t+'", dir: "'+a+'"')}function L(t,e,a){if(t==="category"&&e!==null)return s.category+' "'+e+'"'+(_?" ("+a+")":"");if(t==="category"&&e===null)return s.unknown_category+(_?" ("+a+")":"");if(t==="account"&&e===null)return s.unknown_account+(_?" ("+a+")":"");if(t==="account"&&e!==null)return e+(_?" ("+a+")":"");if(t==="budget"&&e!==null)return s.budget+' "'+e+'"'+(_?" ("+a+")":"");if(t==="budget"&&e===null)return s.unknown_budget+(_?" ("+a+")":"");console.error('Cannot handle: type:"'+t+'"')}const ee=()=>({loading:!1,autoConversion:!1,generateOptions(){let t=U("sankey"),e={},a={};for(let r in D)if(D.hasOwnProperty(r)){let o=D[r];for(let i in o.attributes.transactions)if(o.attributes.transactions.hasOwnProperty(i)){let l=o.attributes.transactions[i],u=this.autoConversion?l.native_currency_code:l.currency_code,d=this.autoConversion?parseFloat(l.native_amount):parseFloat(l.amount),h;if(l.type==="deposit"){let c=G("category",l.category_name,"in",u),p=G("account",l.source_name,"in",u);a[c]=L("category",l.category_name,u),a[p]=L("account",l.source_name,u),h=p+"-"+c+"-"+u,e.hasOwnProperty(h)||(e[h]={from:p,to:c,amount:0}),e[h].amount+=d,h=c+"-"+s.all_money+"-"+u,e.hasOwnProperty(h)||(e[h]={from:c,to:s.all_money+(this.autoConversion?" ("+u+")":""),amount:0}),e[h].amount+=d}if(l.type==="withdrawal"){let c=G("budget",l.budget_name,"out",u);a[c]=L("budget",l.budget_name,u),h=s.all_money+"-"+c+"-"+u,e.hasOwnProperty(h)||(e[h]={from:s.all_money+(this.autoConversion?" ("+u+")":""),to:c,amount:0}),e[h].amount+=d;let p=G("category",l.category_name,"out",u);a[p]=L("category",l.category_name,u),h=c+"-"+p+"-"+u,e.hasOwnProperty(h)||(e[h]={from:c,to:p,amount:0}),e[h].amount+=d;let v=G("account",l.destination_name,"out",u);a[v]=L("account",l.destination_name,u),h=p+"-"+v+"-"+u,e.hasOwnProperty(h)||(e[h]={from:p,to:v,amount:0}),e[h].amount+=d}}}let n={label:"Firefly III dashboard sankey chart",data:[],colorFrom:r=>ht(r.dataset.data[r.dataIndex]?r.dataset.data[r.dataIndex].from:""),colorTo:r=>ht(r.dataset.data[r.dataIndex]?r.dataset.data[r.dataIndex].to:""),colorMode:"gradient",labels:a,size:"min"};for(let r in e)if(e.hasOwnProperty(r)){let o=e[r];n.data.push({from:o.from,to:o.to,flow:o.amount})}return t.data.datasets.push(n),t},drawChart(t){if(q!==null){q.data.datasets=t.data.datasets,q.update();return}q=new S(document.querySelector("#sankey-chart"),t)},getFreshData(){const t=new Date(window.store.get("start")),e=new Date(window.store.get("end")),a=P(dt,{start:t,end:e}),n=window.store.get("cacheValid");let r=window.store.get(a);if(n&&typeof r<"u"){D=r,this.drawChart(this.generateOptions()),this.loading=!1;return}let o={start:y(t,"y-MM-dd"),end:y(e,"y-MM-dd"),type:"withdrawal,deposit",page:1};this.downloadTransactions(o)},downloadTransactions(t){const e=new Date(window.store.get("start")),a=new Date(window.store.get("end")),n=P(dt,{start:e,end:a});new Kt().list(t).then(o=>{if(D=[...D,...o.data.data],parseInt(o.data.meta.pagination.total_pages)>t.page){t.page++,this.downloadTransactions(t);return}window.store.set(n,D),this.drawChart(this.generateOptions()),this.loading=!1})},loadChart(){if(this.loading!==!0){if(this.loading=!0,D.length!==0){this.drawChart(this.generateOptions()),this.loading=!1;return}this.getFreshData()}},init(){D=[],Promise.all([m("autoConversion",!1)]).then(t=>{this.autoConversion=t[0],_=t[0],s.all_money=g.t("firefly.all_money"),s.category=g.t("firefly.category"),s.in=g.t("firefly.money_flowing_in"),s.out=g.t("firefly.money_flowing_out"),s.unknown_category=g.t("firefly.unknown_category_plain"),s.unknown_source=g.t("firefly.unknown_source_plain"),s.unknown_dest=g.t("firefly.unknown_dest_plain"),s.unknown_account=g.t("firefly.unknown_any_plain"),s.unknown_budget=g.t("firefly.unknown_budget_plain"),s.expense_account=g.t("firefly.expense_account"),s.revenue_account=g.t("firefly.revenue_account"),s.budget=g.t("firefly.budget"),at=!0,this.loadChart()}),window.store.observe("end",()=>{at&&(this.transactions=[],this.loadChart())}),window.store.observe("autoConversion",t=>{at&&(this.autoConversion=t,this.loadChart())})}});let nt=!1,b={};function pt(t){return new Gt().list(t).then(a=>{let n=a.data.data;for(let r in n)if(n.hasOwnProperty(r)){let o=n[r];if(o.attributes.active&&o.attributes.pay_dates.length>0){let i=o.attributes.object_group_id===null?0:o.attributes.object_group_id,l=o.attributes.object_group_title===null?g.t("firefly.default_group_title_name_plain"):o.attributes.object_group_title,u=o.attributes.object_group_order===null?0:o.attributes.object_group_order;b.hasOwnProperty(i)||(b[i]={id:i,title:l,order:u,payment_info:{},bills:[]});let d={id:o.id,name:o.attributes.name,amount_min:o.attributes.amount_min,amount_max:o.attributes.amount_max,amount:(parseFloat(o.attributes.amount_max)+parseFloat(o.attributes.amount_min))/2,currency_code:o.attributes.currency_code,native_amount_min:o.attributes.native_amount_min,native_amount_max:o.attributes.native_amount_max,native_amount:(parseFloat(o.attributes.native_amount_max)+parseFloat(o.attributes.native_amount_min))/2,native_currency_code:o.attributes.native_currency_code,transactions:[],pay_dates:o.attributes.pay_dates,paid:o.attributes.paid_dates.length>0};d.expected_amount=t.autoConversion?f(d.native_amount,d.native_currency_code):f(d.amount,d.currency_code),d.expected_times=g.t("firefly.subscr_expected_x_times",{times:o.attributes.pay_dates.length,amount:d.expected_amount});for(let h in o.attributes.paid_dates)if(o.attributes.paid_dates.hasOwnProperty(h)){const c=o.attributes.paid_dates[h];let p=100;t.autoConversion&&(p=Math.round(-100+parseFloat(c.native_amount)*-1/parseFloat(d.native_amount)*100)),t.autoConversion||(p=Math.round(-100+parseFloat(c.amount)*-1/parseFloat(d.amount)*100));let v={amount:t.autoConversion?f(c.native_amount,c.native_currency_code):f(c.amount,c.currency_code),percentage:p,date:y(new Date(c.date),"PP"),foreign_amount:null};c.foreign_currency_code!==null&&(v.foreign_amount=t.autoConversion?c.foreign_native_amount:c.foreign_amount,v.foreign_currency_code=t.autoConversion?c.native_currency_code:c.foreign_currency_code),d.transactions.push(v)}if(b[i].bills.push(d),o.attributes.paid_dates.length===0){const h=o.attributes.pay_dates.length*d.amount,c=o.attributes.pay_dates.length*d.native_amount;b[i].payment_info.hasOwnProperty(d.currency_code)||(b[i].payment_info[d.currency_code]={currency_code:d.currency_code,paid:0,unpaid:0,native_currency_code:d.native_currency_code,native_paid:0,native_unpaid:0}),b[i].payment_info[d.currency_code].unpaid+=h,b[i].payment_info[d.currency_code].native_unpaid+=c}if(o.attributes.paid_dates.length>0){for(let h in o.attributes.paid_dates)if(o.attributes.paid_dates.hasOwnProperty(h)){let c=o.attributes.paid_dates[h];b[i].payment_info.hasOwnProperty(c.currency_code)||(b[i].payment_info[c.currency_code]={currency_code:d.currency_code,paid:0,unpaid:0,native_currency_code:d.native_currency_code,native_paid:0,native_unpaid:0});const p=parseFloat(c.amount)*-1,v=parseFloat(c.native_amount)*-1;b[i].payment_info[c.currency_code].paid+=p,b[i].payment_info[c.currency_code].native_paid+=v}}}}return parseInt(a.data.meta.pagination.total_pages)>t.page?(t.page++,pt(t)):Promise.resolve()})}const ae=()=>({loading:!1,autoConversion:!1,subscriptions:[],startSubscriptions(){this.loading=!0;let t=new Date(window.store.get("start")),e=new Date(window.store.get("end"));const a=window.store.get("cacheValid");let n=window.store.get(P("ds_sub_data",{start:t,end:e}));a&&typeof n<"u",b={},this.subscriptions=[];let r={start:y(t,"y-MM-dd"),end:y(e,"y-MM-dd"),autoConversion:this.autoConversion,page:1};pt(r).then(()=>{let o=Object.values(b);for(let i in o)if(o.hasOwnProperty(i)){let l=o[i];const u=Object.keys(l.payment_info);l.col_size=u.length===1?"col-6 offset-3":"col-6",l.chart_width=u.length===1?"50%":"100%",l.payment_length=u.length,this.subscriptions.push(l)}this.loading=!1})},drawPieChart(t,e,a){let n="#pie_"+t+"_"+a.currency_code;const r=this.autoConversion?a.native_unpaid:a.unpaid,o=this.autoConversion?a.native_paid:a.paid,i=this.autoConversion?a.native_currency_code:a.currency_code,u={type:"doughnut",data:{labels:[g.t("firefly.paid"),g.t("firefly.unpaid")],datasets:[{label:g.t("firefly.subscriptions_in_group",{title:e}),data:[o,r],backgroundColor:["rgb(54, 162, 235)","rgb(255, 99, 132)"],hoverOffset:4}]},options:{plugins:{tooltip:{callbacks:{label:function(h){return h.dataset.label+": "+f(h.raw,i)}}}}}};var d=S.getChart(document.querySelector(n));typeof d<"u"&&d.destroy(),new S(document.querySelector(n),u)},init(){Promise.all([m("autoConversion",!1)]).then(t=>{this.autoConversion=t[0],nt=!0,this.loading===!1&&this.startSubscriptions()}),window.store.observe("end",()=>{nt&&this.loading===!1&&this.startSubscriptions()}),window.store.observe("autoConversion",t=>{nt&&(this.autoConversion=t,this.loading===!1&&this.startSubscriptions())})}});let x={},rt=!1;const ft="ds_pg_data",ne=()=>({loading:!1,autoConversion:!1,sankeyGrouping:"account",piggies:[],getFreshData(){const t=new Date(window.store.get("start")),e=new Date(window.store.get("end")),a=P(ft,{start:t,end:e}),n=window.store.get("cacheValid");let r=window.store.get(a);if(n&&typeof r<"u"){x=r,this.parsePiggies(),this.loading=!1;return}let o={start:y(t,"y-MM-dd"),end:y(e,"y-MM-dd"),page:1};this.downloadPiggyBanks(o)},downloadPiggyBanks(t){const e=new Date(window.store.get("start")),a=new Date(window.store.get("end")),n=P(ft,{start:e,end:a});new Lt().list(t).then(o=>{if(x=[...x,...o.data.data],parseInt(o.data.meta.pagination.total_pages)>t.page){t.page++,this.downloadPiggyBanks(t);return}window.store.set(n,x),this.parsePiggies(),this.loading=!1})},parsePiggies(){let t=[];for(let e in x)if(x.hasOwnProperty(e)){let a=x[e];if(a.attributes.percentage>=100||a.attributes.percentage===0)continue;let n=a.object_group_title??g.t("firefly.default_group_title_name_plain");t.hasOwnProperty(n)||(t[n]={id:a.object_group_id??0,title:n,order:a.object_group_order??0,piggies:[]});let r={id:a.id,name:a.attributes.name,percentage:parseInt(a.attributes.percentage),amount:this.autoConversion?a.attributes.native_current_amount:a.attributes.current_amount,left_to_save:this.autoConversion?a.attributes.native_left_to_save:a.attributes.left_to_save,target_amount:this.autoConversion?a.attributes.native_target_amount:a.attributes.target_amount,save_per_month:this.autoConversion?a.attributes.native_save_per_month:a.attributes.save_per_month,currency_code:this.autoConversion?a.attributes.native_currency_code:a.attributes.currency_code};t[n].piggies.push(r)}this.piggies=Object.values(t)},loadPiggyBanks(){if(this.loading!==!0){if(this.loading=!0,this.piggies.length!==0){this.parsePiggies(),this.loading=!1;return}this.getFreshData()}},init(){x=[],Promise.all([m("autoConversion",!1)]).then(t=>{rt=!0,this.autoConversion=t[0],this.loadPiggyBanks()}),window.store.observe("end",()=>{rt&&(x=[],this.loadPiggyBanks())}),window.store.observe("autoConversion",t=>{rt&&(this.autoConversion=t,this.loadPiggyBanks())})}});S.register({LineController:Pt,LineElement:Dt,ArcElement:xt,BarController:Ot,TimeScale:Ft,PieController:St,BarElement:At,Filler:Mt,Colors:Bt,LinearScale:jt,CategoryScale:Wt,PointElement:It,Tooltip:Vt,Legend:$t});const _t={dates:vt,boxes:Rt,accounts:Ut,budgets:Qt,categories:te,sankey:ee,subscriptions:ae,piggies:ne};function yt(t){Object.keys(t).forEach(e=>{let a=t[e]();Alpine.data(e,()=>a)}),Alpine.start()}document.addEventListener("firefly-iii-bootstrapped",()=>{console.log("Loaded through event listener."),yt(_t)});window.bootstrapped&&(console.log("Loaded through window variable."),yt(_t));
